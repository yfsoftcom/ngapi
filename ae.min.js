"use strict";!function(){function t(t){var e=[];for(var i in t)e.push(i);e=e.sort();var o=[];e.forEach(function(e){var i=t[e];_.isObject(i)&&(i=JSON.stringify(i)),o.push(e+"="+encodeURIComponent(i))});var r=o.join("&"),n=md5(r);return n}var e={Object:{CREATE_ERROR:{errno:-1,code:"CREATE_ERROR",message:"create function should be called by a new object"},SAVE_ERROR:{errno:-2,code:"SAVE_ERROR",message:"save function should be called behind get or create"},REMOVE_ERROR:{errno:-3,code:"REMOVE_ERROR",message:"remove function should be called behind get or create"},OBJECT_ID_NOT_FIND:{errno:-4,code:"OBJECT_ID_NOT_FIND",message:"Object does not find by id or more rows"}},Hook:{BEFORE_HOOK_REJECT:{errno:-301,code:"BEFORE_HOOK_REJECT",message:"before hook reject"},AFTER_HOOK_REJECT:{errno:-302,code:"AFTER_HOOK_REJECT",message:"after hook reject"},UNCATCH_HOOK_REJECT:{errno:-303,code:"UNCATCH_HOOK_REJECT",message:"uncatch exception:"}}},i={DEV:"http://192.168.1.115:8080",STAGING:"http://61.147.98.134:8080",PRODUCT:"http://api.guoran100.com:9001"};angular.module("ngApi",[]).factory("$ae",["$q","$http",function(o,r){var n,s,c={mode:"DEV",appkey:"",masterKey:"",v:"0.0.1"},a="http://192.168.1.115:8080",h=function(i,h){function u(t){if(void 0!==s&&_.isFunction(s))try{s({action:i,args:h,result:t})}catch(e){s({action:i,args:h,result:t,error:e})}}var d=o.defer();if(void 0!==n&&_.isFunction(n))try{if(!n({action:i,args:h}))return d.reject(e.Hook.BEFORE_HOOK_REJECT),d.promise}catch(f){var p=_.clone(e.Hook.UNCATCH_HOOK_REJECT);return p.message=p.message+f,d.reject(p),d.promise}delete h.scope;var l=c.v;if(_.isObject(i))l=i.v||l,i=i.action;else if(_.isString(i)){var v=i.indexOf("@");v>1&&(l=i.substr(v+1),i=i.substr(0,v))}var E={method:i,appkey:c.appkey,masterKey:c.masterKey,timestamp:_.now(),param:h,v:l},m=t(E);return E.sign=m,delete E.masterKey,r.post(a+"/api",E).success(function(t){0===t.errno?d.resolve(t.data):d.reject(t),u(t)}).error(function(t){d.reject(t),u(t)}),d.promise},u=function(t,e){if(!_.isString(t))throw new Error("Object Class should be String");this._t=t,this._d=e||{},this.objectId=this._d.id||void 0};u.prototype.toJson=function(){return this._d},u.prototype.print=function(){console.log("id="+this.objectId),console.log("createAt="+this._d.createAt),console.log("updateAt="+this._d.updateAt),console.log("data="+JSON.stringify(this._d))},u.prototype.set=function(t,e){return _.isObject(t)?this._d=_.extend(this._d,t):this._d[t]=e,this},u.prototype.get=function(t){return t?this._d[t]:this._d},u.prototype.getById=function(t){var e=o.defer();this.objectId=t;var i=this,r={table:this._t,id:t};return h("api.get",r).then(function(t){i._d=t,e.resolve(i)})["catch"](function(t){e.reject(t)}),e.promise},u.prototype.save=function(t){var i=o.defer();if(void 0===this.objectId)return i.reject(e.Object.SAVE_ERROR),i.promise;t&&(this._d=t),this._d.updateAt=(new Date).getTime();var r=this,n={table:this._t,condition:" id = "+this.objectId,row:this._d};return h("api.update",n).then(function(){i.resolve(r)})["catch"](function(t){i.reject(t)}),i.promise},u.prototype.remove=function(){var t=o.defer();if(void 0===this.objectId)return t.reject(e.Object.REMOVE_ERROR),t.promise;var i={table:this._t,id:this.objectId};return h("api.remove",i).then(function(){t.resolve(1)})["catch"](function(e){t.reject(e)}),t.promise},u.prototype.create=function(t){var i=o.defer();if(void 0!==this.objectId)return i.reject(e.Object.CREATE_ERROR),i.promise;t&&(this._d=t),this._d.updateAt=this._d.createAt=(new Date).getTime();var r=this,n={table:this._t,row:this._d};return h("api.create",n).then(function(t){r.objectId=t.insertId,r._d.id=r.objectId,i.resolve(r)})["catch"](function(t){i.reject(t)}),i.promise};var d=function(t){if(!_.isString(t))throw new Error("Class should be String");this._t=t,this._s="id-",this._l=100,this._k=0,this._c=" 1=1 ",this._f="*"};d.prototype.sort=function(t){return this._s=t,this},d.prototype.page=function(t,e){return this._l=e||100,this._k=(t-1)*this._l,this},d.prototype.condition=function(t){return this._c=t,this},d.prototype.and=function(t){return this._c=this._c+" and "+t,this},d.prototype.or=function(t){return this._c=this._c+" or "+t,this},d.prototype.select=function(t){return _.isString(t)&&(t=t.split(",")),_.contains(t,"id")||t.push("id"),_.contains(t,"createAt")||t.push("createAt"),_.contains(t,"updateAt")||t.push("updateAt"),t=t.join(","),this._f=t,this},d.prototype.count=function(){var t=o.defer(),e={table:this._t,condition:this._c};return h("api.count",e).then(function(e){t.resolve(e)})["catch"](function(e){t.reject(e)}),t.promise},d.prototype.findAndCount=function(){var t=o.defer(),e=this,i={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return h("api.findAndCount",i).then(function(i){var o=[];_.isEmpty(i)||_.each(i.rows,function(t){var i=new u(e._t,t);o.push(i)}),i.rows=o,t.resolve(i)})["catch"](function(e){t.reject(e)}),t.promise},d.prototype.first=function(){var t=o.defer(),e=this,i={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return h("api.first",i).then(function(i){var o;_.isArray(i)?0===i.length&&(o=new u(e._t),t.resolve(o)):_.isObject(i)&&(o=new u(e._t,i),t.resolve(o))})["catch"](function(e){t.reject(e)}),t.promise},d.prototype.find=function(){var t=o.defer(),e=this,i={table:this._t,condition:this._c,sort:this._s,limit:this._l,skip:this._k,fields:this._f};return h("api.find",i).then(function(i){var o=[];_.isEmpty(i)||_.each(i,function(t){var i=new u(e._t,t);o.push(i)}),t.resolve(o)})["catch"](function(e){t.reject(e)}),t.promise},d.prototype.clear=function(){var t=o.defer(),e={table:this._t,condition:this._c};return h("api.clear",e).then(function(e){t.resolve(e)})["catch"](function(e){t.reject(e)}),t.promise};var f=function(t){this._f=t};return f.prototype.invoke=function(t){var e=o.defer();return h(this._f,t).then(function(t){e.resolve(t)})["catch"](function(t){e.reject(t)}),e.promise},{init:function(t){t=t||{};for(var e in t)c[e]=t[e];a=c.host||i[c.mode]},beforeHook:function(t){n=t},afterHook:function(t){s=t},Object:u,Query:d,Function:f}}])}();